<source>
  @type tail
  tag nginx.error
  path /var/log/nginx/error.log
  pos_file /var/log/td-agent/nginx.error.log.pos
  multiline_flush_interval 3s
  emit_unmatched_lines true
  format nginx
  time_format %d/%b/%Y:%H:%M:%S %z
  <parse>
    @type nginx_error_multiline
  </parse>
</source>


<filter nginx.error>
  @type nginx_error_multiline
  format_firstline /\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2} \[\w+\] \d?\d{0,5}?\d{0,5}/
  format1 /^(?<message>.*)$/
</filter>


<match nginx.error>
  @type file
  path /var/log/td-agent/nginx.error.log
  append true
  compress gzip
  <buffer>
    timekey 1d
    timekey_use_utc true
    timekey_wait 10m
  </buffer>
  @type prometheus
  <metric>
    name nginx_requests_total
    type counter
    desc Total number of Nginx requests
    key request_uri
  </metric>
</match>